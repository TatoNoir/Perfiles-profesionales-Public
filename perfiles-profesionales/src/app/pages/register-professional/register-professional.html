<ion-content [fullscreen]="true">
  <!-- Header -->
  <ion-header [translucent]="true">
    <ion-toolbar>
      <ion-button fill="clear" slot="start" (click)="closeModal()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
      <ion-title>Registro de Profesional</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="register-page">
    <!-- Progress Steps -->
    <div class="progress-container">
      <div class="progress-steps">
        <!-- Step 1: Personal Data -->
        <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
          <div class="step-circle">
            <ion-icon *ngIf="currentStep > 1" name="checkmark"></ion-icon>
            <ion-icon *ngIf="currentStep === 1" name="person"></ion-icon>
          </div>
          <span class="step-label">Datos Personales</span>
        </div>

        <div class="step-line" [class.completed]="currentStep > 1"></div>

        <!-- Step 2: Location -->
        <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
          <div class="step-circle">
            <ion-icon *ngIf="currentStep > 2" name="checkmark"></ion-icon>
            <ion-icon *ngIf="currentStep === 2" name="location"></ion-icon>
          </div>
          <span class="step-label">Ubicación</span>
        </div>

        <div class="step-line" [class.completed]="currentStep > 2"></div>

        <!-- Step 3: Profile Photo -->
        <div class="step" [class.active]="currentStep === 3" [class.completed]="currentStep > 3">
          <div class="step-circle">
            <ion-icon *ngIf="currentStep > 3" name="checkmark"></ion-icon>
            <ion-icon *ngIf="currentStep === 3" name="camera"></ion-icon>
          </div>
          <span class="step-label">Foto de Perfil</span>
        </div>
      </div>
    </div>

    <!-- Success Message -->
    <div *ngIf="showSuccessMessage" class="success-message">
      <ion-icon name="checkmark-circle" class="success-icon"></ion-icon>
      <h2>¡Registro Exitoso!</h2>
      <p>Tu solicitud de registro ha sido enviada. Te contactaremos pronto.</p>
    </div>

    <!-- Step Content -->
    <div class="step-content" *ngIf="!showSuccessMessage">
      <!-- Step 1: Personal Data -->
      <ion-card *ngIf="currentStep === 1" class="step-card">
        <ion-card-content>
          <h2 class="step-title">
            <ion-icon [name]="stepIcon"></ion-icon>
            {{ stepTitle }} *
          </h2>

          <form class="registration-form">
            <!-- First Name -->
            <ion-item class="form-item">
              <ion-label position="stacked">Nombre *</ion-label>
              <ion-input
                [(ngModel)]="personalData.firstName"
                name="firstName"
                placeholder="Ingresa tu nombre"
                required>
              </ion-input>
            </ion-item>

            <!-- Last Name -->
            <ion-item class="form-item">
              <ion-label position="stacked">Apellido *</ion-label>
              <ion-input
                [(ngModel)]="personalData.lastName"
                name="lastName"
                placeholder="Ingresa tu apellido"
                required>
              </ion-input>
            </ion-item>

            <!-- Email -->
            <ion-item class="form-item">
              <ion-label position="stacked">Email *</ion-label>
              <ion-input
                [(ngModel)]="personalData.email"
                name="email"
                type="email"
                placeholder="tu@email.com"
                required>
              </ion-input>
            </ion-item>

            <!-- Phone Fields -->
            <div class="phone-fields">
              <!-- Area Code -->
              <ion-item class="form-item phone-area-code">
                <ion-label position="stacked">Código de Área *</ion-label>
                <ion-input
                  [(ngModel)]="personalData.areaCode"
                  name="areaCode"
                  type="tel"
                  placeholder="011"
                  maxlength="4"
                  required>
                </ion-input>
              </ion-item>

              <!-- Phone Number -->
              <ion-item class="form-item phone-number">
                <ion-label position="stacked">Teléfono *</ion-label>
                <ion-input
                  [(ngModel)]="personalData.phone"
                  name="phone"
                  type="tel"
                  placeholder="1234-5678"
                  maxlength="10"
                  required>
                </ion-input>
              </ion-item>
            </div>

            <!-- Password Fields -->
            <div class="password-fields">
              <!-- Password -->
              <ion-item class="form-item password-field">
                <ion-label position="stacked">Contraseña *</ion-label>
                <ion-input
                  [(ngModel)]="personalData.password"
                  name="password"
                  type="password"
                  placeholder="Ingresa tu contraseña"
                  required>
                </ion-input>
              </ion-item>

              <!-- Confirm Password -->
              <ion-item class="form-item confirm-password-field">
                <ion-label position="stacked">Repita Contraseña *</ion-label>
                <ion-input
                  [(ngModel)]="personalData.confirmPassword"
                  name="confirmPassword"
                  type="password"
                  placeholder="Repite tu contraseña"
                  required>
                </ion-input>
              </ion-item>
            </div>

            <!-- Password Match Error -->
            <div *ngIf="personalData.password && personalData.confirmPassword && !passwordsMatch()" class="password-error">
              <ion-icon name="alert-circle"></ion-icon>
              <span>Las contraseñas no coinciden</span>
            </div>

            <!-- Activities -->
            <div class="activities-section">
              <ion-label class="field-label">Actividades *</ion-label>

              <!-- Search Input -->
              <ion-item class="form-item search-item">
                <ion-input
                  [(ngModel)]="activitySearchTerm"
                  (ionInput)="onActivitySearch($event)"
                  (ionFocus)="onActivityFocus()"
                  (ionBlur)="onActivityBlur()"
                  placeholder="Buscar actividades..."
                  clearInput="true"
                  name="activitySearch">
                </ion-input>
              </ion-item>

              <!-- Selected Activities -->
              <div class="selected-activities" *ngIf="getSelectedActivities().length > 0">
                <div class="selected-activity" *ngFor="let activity of getSelectedActivities()">
                  <span class="activity-name">{{ activity.name }}</span>
                  <ion-button
                    fill="clear"
                    size="small"
                    (click)="removeActivity(activity.id)"
                    class="remove-button">
                    <ion-icon name="close"></ion-icon>
                  </ion-button>
                </div>
              </div>

              <!-- Activities Dropdown -->
              <div class="activities-dropdown"
                   *ngIf="showActivitiesDropdown && (filteredActivities.length > 0 || activitySearchTerm)">
                <!-- Activities List -->
                <div class="activities-list" *ngIf="filteredActivities.length > 0">
                  <div
                    class="activity-item"
                    *ngFor="let activity of filteredActivities"
                    (click)="onActivitySelect(activity)"
                    [class.selected]="isActivitySelected(activity.id)">
                    <div class="activity-info">
                      <span class="activity-name">{{ activity.name }}</span>
                      <span class="activity-description" *ngIf="activity.description">{{ activity.description }}</span>
                    </div>
                    <ion-icon
                      *ngIf="isActivitySelected(activity.id)"
                      name="checkmark"
                      class="check-icon">
                    </ion-icon>
                  </div>
                </div>

                <!-- No Results -->
                <div class="no-results" *ngIf="filteredActivities.length === 0 && activitySearchTerm">
                  <p>No se encontraron actividades con ese término.</p>
                </div>
              </div>
            </div>

            <!-- Description -->
            <ion-item class="form-item textarea-item">
              <ion-label position="stacked">Descripción *</ion-label>
              <ion-textarea
                [(ngModel)]="personalData.description"
                name="description"
                placeholder="Cuéntanos sobre tu experiencia y servicios..."
                rows="4"
                required>
              </ion-textarea>
            </ion-item>
          </form>
        </ion-card-content>
      </ion-card>

      <!-- Step 2: Location -->
      <ion-card *ngIf="currentStep === 2" class="step-card">
        <ion-card-content>
          <h2 class="step-title">
            <ion-icon [name]="stepIcon"></ion-icon>
            {{ stepTitle }} *
          </h2>

          <form class="registration-form">
            <!-- Street and Number -->
            <div class="address-fields">
              <!-- Street -->
              <ion-item class="form-item street-field">
                <ion-label position="stacked">Calle *</ion-label>
                <ion-input
                  [(ngModel)]="locationData.street"
                  name="street"
                  placeholder="Av. Corrientes"
                  required>
                </ion-input>
              </ion-item>

              <!-- Street Number -->
              <ion-item class="form-item number-field">
                <ion-label position="stacked">Altura *</ion-label>
                <ion-input
                  [(ngModel)]="locationData.streetNumber"
                  name="streetNumber"
                  placeholder="1234"
                  type="number"
                  required>
                </ion-input>
              </ion-item>
            </div>

            <!-- Province -->
            <div class="province-section">
              <ion-label class="field-label">Provincia *</ion-label>

              <!-- Province Search Input -->
              <ion-item class="form-item search-item">
                <ion-input
                  [(ngModel)]="provinceSearchTerm"
                  (ionInput)="onProvinceSearch($event)"
                  (ionFocus)="onProvinceFocus()"
                  (ionBlur)="onProvinceBlur()"
                  placeholder="Buscar provincia..."
                  clearInput="true"
                  name="provinceSearch">
                </ion-input>
              </ion-item>

              <!-- Province Dropdown -->
              <div class="provinces-dropdown"
                   *ngIf="showProvincesDropdown && (filteredProvinces.length > 0 || provinceSearchTerm)">
                <!-- Provinces List -->
                <div class="provinces-list" *ngIf="filteredProvinces.length > 0">
                  <div
                    class="province-item"
                    *ngFor="let province of filteredProvinces"
                    (click)="onProvinceSelect(province)">
                    <span class="province-name">{{ province.name }}</span>
                  </div>
                </div>

                <!-- No Results -->
                <div class="no-results" *ngIf="filteredProvinces.length === 0 && provinceSearchTerm">
                  <p>No se encontraron provincias con ese término.</p>
                </div>
              </div>
            </div>

            <!-- City -->
            <div class="city-section">
              <ion-label class="field-label">Ciudad *</ion-label>

              <!-- City Search Input -->
              <ion-item class="form-item search-item">
                <ion-input
                  [(ngModel)]="citySearchTerm"
                  (ionInput)="onCitySearch($event)"
                  (ionFocus)="onCityFocus()"
                  (ionBlur)="onCityBlur()"
                  placeholder="Buscar ciudad..."
                  clearInput="true"
                  name="citySearch"
                  [disabled]="!locationData.state_id">
                </ion-input>
              </ion-item>

              <!-- City Dropdown -->
              <div class="cities-dropdown"
                   *ngIf="showCitiesDropdown && (filteredCities.length > 0 || citySearchTerm)">
                <!-- Cities List -->
                <div class="cities-list" *ngIf="filteredCities.length > 0">
                  <div
                    class="city-item"
                    *ngFor="let city of filteredCities"
                    (click)="onCitySelect(city)">
                    <span class="city-name">{{ city.name }}</span>
                  </div>
                </div>

                <!-- No Results -->
                <div class="no-results" *ngIf="filteredCities.length === 0 && citySearchTerm">
                  <p>No se encontraron ciudades con ese término.</p>
                </div>
              </div>
            </div>

            <!-- Work Zone -->
            <ion-item class="form-item textarea-item">
              <ion-label position="stacked">Zona de Trabajo / Cobertura *</ion-label>
              <ion-textarea
                [(ngModel)]="locationData.workZone"
                name="workZone"
                placeholder="Ej: CABA y Gran Buenos Aires, Radio de 30km desde mi ubicación, etc."
                rows="3"
                required>
              </ion-textarea>
            </ion-item>

            <p class="help-text">Describe el área geográfica donde ofreces tus servicios</p>
          </form>
        </ion-card-content>
      </ion-card>

      <!-- Step 3: Profile Photo -->
      <ion-card *ngIf="currentStep === 3" class="step-card">
        <ion-card-content>
          <h2 class="step-title">
            <ion-icon [name]="stepIcon"></ion-icon>
            {{ stepTitle }} *
          </h2>

          <div class="photo-upload-section">
            <div class="photo-upload-area" (click)="fileInput.click()">
              <div class="upload-icon">
                <ion-icon name="camera"></ion-icon>
              </div>
              <p class="upload-text">Subir foto</p>
            </div>

            <input
              #fileInput
              type="file"
              accept="image/jpeg,image/jpg,image/png"
              (change)="onFileSelected($event)"
              style="display: none;">

            <p class="upload-instructions">
              Sube una foto profesional que te represente.<br>
              Formatos: JPG, PNG (máx. 5MB)
            </p>

            <!-- Preview -->
            <div *ngIf="profilePhoto.profilePhoto" class="photo-preview">
              <img [src]="getPhotoPreview()" alt="Preview">
              <p class="photo-name">{{ profilePhoto.profilePhoto.name }}</p>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Navigation Buttons -->
    <div class="navigation-buttons" *ngIf="!showSuccessMessage">
      <ion-button
        *ngIf="canGoPrevious"
        (click)="previousStep()"
        fill="outline"
        color="medium"
        class="nav-button">
        <ion-icon name="arrow-back" slot="start"></ion-icon>
        Anterior
      </ion-button>

      <ion-button
        *ngIf="!isLastStep"
        (click)="nextStep()"
        [disabled]="!canGoNext"
        fill="solid"
        color="primary"
        class="nav-button">
        Siguiente
        <ion-icon name="arrow-forward" slot="end"></ion-icon>
      </ion-button>

      <ion-button
        *ngIf="isLastStep"
        (click)="submitRegistration()"
        [disabled]="!canGoNext || isSubmitting"
        fill="solid"
        color="primary"
        class="nav-button">
        <ion-spinner *ngIf="isSubmitting" slot="start" name="crescent"></ion-spinner>
        {{ submitButtonText }}
      </ion-button>
    </div>
  </div>
</ion-content>
