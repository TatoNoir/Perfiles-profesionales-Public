<div class="reviews-page">
  <h2 class="title">Valoraciones</h2>
  <ion-card>
    <ion-card-content>
      <ion-list class="reviews-list">
        <ion-item *ngIf="loadingReviews">
          <ion-label>
            <div style="text-align: center; padding: 2rem;">
              <ion-spinner></ion-spinner>
              <p>Cargando valoraciones...</p>
            </div>
          </ion-label>
        </ion-item>
        <ion-item *ngIf="!loadingReviews && reviews.length === 0">
          <ion-label>
            <div style="text-align: center; padding: 2rem;">
              <p>No hay valoraciones disponibles</p>
            </div>
          </ion-label>
        </ion-item>
        <ion-item lines="full" *ngFor="let r of reviews" class="review-item">
          <div class="left">
            <div class="top-row">
              <span class="user">{{ getUserDisplayName(r) }}</span>
              <span class="stars">
                <ion-icon *ngFor="let i of range(5)" [name]="i < r.value ? 'star' : 'star-outline'"></ion-icon>
              </span>
              <span class="rating-number">({{ r.value }}/5)</span>
            </div>
            <div class="comment" *ngIf="hasComment(r)">{{ r.comment }}</div>
            <div class="comment" *ngIf="!hasComment(r)"><em>Sin comentario</em></div>
            <div class="meta">
              <span class="date">{{ formatDate(r.created_at) | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="answer-section" *ngIf="hasAnswer(r)">
              <div class="answer-label">Tu respuesta:</div>
              <div class="answer-text">{{ r.answer }}</div>
            </div>
          </div>
          <div class="right">
            <ion-button size="small" fill="clear" (click)="onReply(r)">
              {{ hasAnswer(r) ? 'Modificar respuesta' : 'Responder' }}
            </ion-button>
          </div>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <ion-modal [isOpen]="isReplyOpen" (didDismiss)="closeReply()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ selectedReview?.answer ? 'Modificar respuesta' : 'Responder valoraci√≥n' }}</ion-title>
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="closeReply()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <ion-textarea
          label="Respuesta"
          labelPlacement="stacked"
          placeholder="Escribe tu respuesta..."
          [(ngModel)]="replyText"
          [disabled]="savingAnswer"
          rows="6">
        </ion-textarea>
        <div style="margin-top: .75rem; display:flex; justify-content:flex-end; gap:.5rem;">
          <ion-button
            fill="outline"
            color="medium"
            (click)="closeReply()"
            [disabled]="savingAnswer">
            Cancelar
          </ion-button>
          <ion-button
            color="primary"
            (click)="submitReply()"
            [disabled]="savingAnswer || !replyText.trim()">
            <ion-spinner *ngIf="savingAnswer" name="crescent"></ion-spinner>
            <span *ngIf="!savingAnswer">{{ selectedReview?.answer ? 'Actualizar' : 'Enviar' }}</span>
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-toast
    [isOpen]="showToast"
    [message]="toastMessage"
    [color]="toastColor"
    [duration]="3000"
    (didDismiss)="showToast = false">
  </ion-toast>
</div>

